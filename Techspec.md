# Техническое Задание (ТЗ) на Разработку Telegram-Скрипта для Копирования Постов

## 1. Общая Информация

### 1.1. Название Проекта
Скрипт для копирования постов из приватной Telegram-группы в другую группу с использованием Telethon.

### 1.2. Роль Разработчика
ИИ-агент в роли разработчика должен реализовать скрипт на основе данного ТЗ, обеспечивая полное соответствие требованиям. Разработка включает написание кода на Python, настройку Docker Compose для контейнеризации, тестирование и документацию.

### 1.3. Цель Проекта
Разработать автоматизированный скрипт (в форме Telegram-бота/клиента), который взаимодействует с пользовательским аккаунтом Telegram для полного копирования всех постов из одной приватной группы (источник) в другую группу (целевая). Копирование должно быть последовательным, начиная с самого первого (самого старого) поста, и обеспечивать 100% идентичность оригинальным постам (текст, фото, видео, хештеги, эмодзи, форматирование и другие элементы). Скрипт должен учитывать лимиты Telegram API, чтобы минимизировать риск бана аккаунта.

### 1.4. Область Применения
- Скрипт предназначен для однократного или периодического запуска под контролем пользователя.
- Используется пользовательский аккаунт (не бот-аккаунт), так как требуется доступ к приватной группе.
- Целевая группа должна быть под контролем пользователя (с правами на публикацию).

### 1.5. Предположения и Ограничения
- Пользователь предоставит API ID, API Hash, номер телефона и код авторизации для Telegram аккаунта (через конфигурацию скрипта).
- Источник — приватная группа, в которой аккаунт пользователя является участником.
- Целевая группа — собственная группа пользователя с правами администратора.
- Скрипт не предназначен для спама или массовой рассылки; фокус на архивации/миграции контента.
- Нет поддержки для постов с опросами, голосованиями или другими интерактивными элементами, если они не копируются идентично через API (требуется проверка в реализации).

## 2. Функциональные Требования

### 2.1. Авторизация
- Скрипт должен авторизоваться в Telegram с использованием пользовательского аккаунта (не Bot API, а MTProto API через Telethon).
- Поддержка двухфакторной аутентификации (если включена).
- Хранение сессии в файле (например, `session.session`) для повторного использования без повторной авторизации.
- Запрет множественной авторизации: скрипт должен проверять, активна ли сессия, и не инициировать новую без необходимости.

### 2.2. Идентификация Групп
- Пользователь предоставляет ID или username исходной и целевой групп через конфигурационный файл (например, config.yaml или .env).
- Скрипт должен получить entity групп с помощью `client.get_entity()` для валидации доступа.

### 2.3. Итерация и Копирование Постов
- Итерация по всем постам в исходной группе, начиная с самого первого (самого старого) поста.
  - Использовать `client.iter_messages(entity, reverse=True)` для получения сообщений в хронологическом порядке (от старого к новому).
  - Обработка пагинации: лимит на запрос (например, 100 сообщений за раз) для эффективности.
- Для каждого поста:
  - Извлечь полный контент: текст (с форматированием, хештегами, эмодзи), медиа (фото, видео, документы), группированные медиа (альбомы), ссылки и т.д.
  - Копировать идентично в целевую группу без метки "forwarded from" (чтобы обеспечить 100% идентичность):
    - Не использовать `message.forward_to()`, так как это добавляет метку пересылки.
    - Вместо этого: скачать медиа (если нужно) и отправить новое сообщение с помощью `client.send_message(target_entity, message=original_text, file=original_media, parse_mode='html' или 'md' для сохранения форматирования)`.
    - Для альбомов: использовать `client.send_file()` с группировкой.
    - Сохранить хештеги, ссылки и другие метаданные в тексте.
- Последовательное копирование: по одному посту за раз, с паузами для соблюдения лимитов.
- Обработка ошибок: если пост не копируется (например, из-за размера медиа), логировать и продолжить.

### 2.4. Обработка Лимитов и Анти-Бан Механизмы
- Учитывать официальные лимиты Telegram API:
  - Глобальный: не более 30 запросов/секунду.
  - На группу: не более 20 сообщений/минуту.
  - На отправку сообщений: 1 сообщение/секунду в индивидуальный чат, но для групп — осторожно.
  - Forwarding: до 100 сообщений за раз, но с учетом глобальных лимитов.
- Внедрить задержки:
  - Пауза 2-5 секунд между отправками сообщений.
  - Распределить копирование на интервалы (например, не более 30 сообщений в час, с возможностью настройки).
  - Мониторинг: если обнаружен flood wait (ошибка FloodWaitError в Telethon), автоматически ждать указанное время и продолжить.
- Избегать банов:
  - Не превышать 30-50 сообщений в день для новых аккаунтов.
  - Использовать прокси (опционально, через Telethon proxy параметр) для маскировки IP.
  - Логировать все действия для аудита.
  - Опция для сухого прогона (dry run): симулировать копирование без реальной отправки.

### 2.5. Логирование и Мониторинг
- Логировать каждый шаг: авторизация, итерация, копирование, ошибки.
- Использовать библиотеку logging с уровнями (DEBUG, INFO, ERROR).
- Опция для прогресс-бара (например, с tqdm).

### 2.6. Конфигурация
- Файл конфигурации (.env или YAML): API_ID, API_HASH, PHONE, SOURCE_GROUP_ID, TARGET_GROUP_ID, DELAY_SECONDS и т.д.
- Поддержка переменных окружения для Docker.

## 3. Нефункциональные Требования

### 3.1. Производительность
- Эффективная обработка больших объемов (тысячи постов) с пагинацией.
- Минимальное потребление ресурсов: не более 512 МБ RAM.

### 3.2. Безопасность
- Хранение сессии и конфигурации в зашифрованном виде (опционально, с использованием cryptography).
- Не хранить пароли в коде.
- Соответствие стандартам: PEP 8 для кода, избегать уязвимостей (например, input validation).

### 3.3. Надежность
- Обработка исключений: FloodWaitError, PeerFloodError, AuthKeyDuplicatedError и т.д.
- Возобновление после прерывания: хранить ID последнего скопированного поста в файле для resumption.

### 3.4. Соответствие Стандартам
- Код: Python 3.10+, PEP 8, type hints (mypy).
- Документация: Docstrings, README.md с инструкциями по запуску.
- Тестирование: Unit-тесты с pytest для ключевых функций.
- Лицензия: MIT или аналогичная.

## 4. Технологический Стек

- **Язык**: Python 3.12.
- **Библиотеки**:
  - Telethon (для Telegram API).
  - PyYAML или python-dotenv (для конфигурации).
  - logging, tqdm (для прогресса).
  - cryptography (опционально для шифрования).
- **Контейнеризация**: Docker Compose.
  - Минималистичный набор: Dockerfile на базе python:3.12-slim (без лишних пакетов).
  - Запуск от root (user: root в Dockerfile, несмотря на best practices; для соответствия требованию).
  - docker-compose.yml: один сервис, volumes для сессии и конфига, entrypoint для скрипта.

## 5. Архитектура

### 5.1. Структура Кода
- main.py: Точка входа, авторизация, основной цикл.
- config.py: Загрузка конфигурации.
- copier.py: Функции для итерации и копирования.
- utils.py: Вспомогательные (задержки, логи).

### 5.2. Docker Setup
- Dockerfile:
  ```
  FROM python:3.12-slim
  USER root
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install --no-cache-dir -r requirements.txt
  COPY . .
  CMD ["python", "main.py"]
  ```
- requirements.txt: telethon, pyyaml, tqdm.
- docker-compose.yml:
  ```
  version: '3'
  services:
    telegram-copier:
      build: .
      user: root
      volumes:
        - .:/app
      environment:
        - API_ID=${API_ID}
      restart: no
  ```
- Минималистично: без ненужных сервисов, фокус на запуске скрипта.

## 6. План Реализации

### 6.1. Этапы
1. Настройка Telethon клиента и авторизация.
2. Получение entities групп.
3. Итерация по сообщениям с reverse=True.
4. Для каждого: извлечь контент, отправить в цель с задержкой.
5. Обработка ошибок и лимитов.
6. Контейнеризация и тестирование.

### 6.2. Тестирование
- Unit-тесты: Моки для Telethon (asynctest).
- Интеграционное: Тест на тестовых группах с малым количеством постов.
- Стресс-тест: Симуляция лимитов.

## 7. Документация и Поддержка

- README.md: Инструкции по получению API_ID/Hash, настройке .env, запуску в Docker.
- Комментарии в коде.
- Возможные расширения: GUI или cron для периодического запуска (не в scope). 

Это ТЗ является полным и подробным. Разработчик (ИИ-агент) должен реализовать проект в соответствии с ним, обеспечивая безопасность и эффективность.
