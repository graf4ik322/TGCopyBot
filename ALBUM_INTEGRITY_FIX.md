# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞–ª—å–±–æ–º–æ–≤ –≤ –±–∞—Ç—á–∞—Ö

## üéØ –ü–†–û–ë–õ–ï–ú–ê

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:** –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç —Ä–∞–∑—Ä–µ–∑–∞—Ç—å –∞–ª—å–±–æ–º—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏

### –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:
1. **–ê–ª—å–±–æ–º = –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π** —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `grouped_id`
2. **–ë–∞—Ç—á –º–æ–∂–µ—Ç —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –∞–ª—å–±–æ–º** - —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞—Ç—á–µ #1, —á–∞—Å—Ç—å –≤ –±–∞—Ç—á–µ #2
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∞–ª—å–±–æ–º –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:
```
–ê–ª—å–±–æ–º –∏–∑ 5 —Ñ–æ—Ç–æ = 5 —Å–æ–æ–±—â–µ–Ω–∏–π —Å grouped_id=12345
–ë–∞—Ç—á —Ä–∞–∑–º–µ—Ä–æ–º 25:
‚ùå –ë–∞—Ç—á #1: —Å–æ–æ–±—â–µ–Ω–∏—è 1-25 (–≤–∫–ª—é—á–∞–µ—Ç 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞)  
‚ùå –ë–∞—Ç—á #2: —Å–æ–æ–±—â–µ–Ω–∏—è 26-50 (–≤–∫–ª—é—á–∞–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 2 —Å–æ–æ–±—â–µ–Ω–∏—è)

–†–µ–∑—É–ª—å—Ç–∞—Ç: 3 —Ñ–æ—Ç–æ + 2 —Ñ–æ—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ ‚ùå –≤–º–µ—Å—Ç–æ –∞–ª—å–±–æ–º–∞ –∏–∑ 5 ‚úÖ
```

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_ensure_complete_albums()`

**–õ–æ–≥–∏–∫–∞:**
1. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞—Ç—á** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–ø–æ–ª–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
2. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** - –µ—Å–ª–∏ –æ–Ω–æ —á–∞—Å—Ç—å –∞–ª—å–±–æ–º–∞
3. **–î–æ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è** —Ç–æ–≥–æ –∂–µ –∞–ª—å–±–æ–º–∞
4. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é** —á–µ—Ä–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ ID

### –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
async def _ensure_complete_albums(self, batch: List[Message], iter_params: dict) -> List[Message]:
    """
    –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∞–ª—å–±–æ–º—ã –Ω–µ —Ä–∞–∑—Ä–µ–∑–∞–Ω—ã –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏.
    """
    if not batch:
        return batch
    
    # –ù–∞—Ö–æ–¥–∏–º –∞–ª—å–±–æ–º—ã –≤ –±–∞—Ç—á–µ
    albums_in_batch = {}
    for message in batch:
        if hasattr(message, 'grouped_id') and message.grouped_id:
            if message.grouped_id not in albums_in_batch:
                albums_in_batch[message.grouped_id] = []
            albums_in_batch[message.grouped_id].append(message)
    
    if not albums_in_batch:
        return batch  # –ù–µ—Ç –∞–ª—å–±–æ–º–æ–≤ - –±–∞—Ç—á –≥–æ—Ç–æ–≤
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤ –≤ –∫–æ–Ω—Ü–µ –±–∞—Ç—á–∞
    last_message = batch[-1]
    
    for grouped_id, album_messages in albums_in_batch.items():
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–∞—Ç—á–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∞–ª—å–±–æ–º—É,
        # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∞–ª—å–±–æ–º–∞ –ø–æ—Å–ª–µ –±–∞—Ç—á–∞
        if any(msg.id == last_message.id for msg in album_messages):
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                check_params = iter_params.copy()
                check_params['offset_id'] = last_message.id
                check_params['limit'] = 10  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
                
                async for next_message in self.client.iter_messages(**check_params):
                    if (hasattr(next_message, 'grouped_id') and 
                        next_message.grouped_id == grouped_id):
                        # –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫ –±–∞—Ç—á—É
                        batch.append(next_message)
                        album_messages.append(next_message)
                    else:
                        # –ê–ª—å–±–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω
                        break
                        
            except Exception as e:
                self.logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–ª—å–±–æ–º–∞ {grouped_id}: {e}")
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞—Ç—á –ø–æ ID –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏
    batch.sort(key=lambda msg: msg.id)
    
    return batch
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `_get_message_batches()`:

```python
# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞—Ç—á–∞:
batch = await self._ensure_complete_albums(batch, iter_params)
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

| –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|----------------|-------------------|
| ‚ùå –ê–ª—å–±–æ–º—ã –º–æ–≥—É—Ç —Ä–∞–∑—Ä–µ–∑–∞—Ç—å—Å—è | ‚úÖ –ê–ª—å–±–æ–º—ã –≤—Å–µ–≥–¥–∞ —Ü–µ–ª—ã–µ |
| ‚ùå –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–µ—Ä—è–µ—Ç—Å—è | ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è |
| ‚ùå –§–æ—Ç–æ/–≤–∏–¥–µ–æ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è | ‚úÖ –§–æ—Ç–æ/–≤–∏–¥–µ–æ –∫–∞–∫ –∞–ª—å–±–æ–º |

## üîß –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

–î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```
DEBUG: –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ 12346 –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞ 12345
DEBUG: –ë–∞—Ç—á —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–æ 28 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞–ª—å–±–æ–º–æ–≤
```

## üéØ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ê–ª—å–±–æ–º –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –±–∞—Ç—á–∞
```
–ë–∞—Ç—á —Ä–∞–∑–º–µ—Ä–æ–º 25, –∞–ª—å–±–æ–º –∏–∑ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–∑–∏—Ü–∏—è—Ö 23-27
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–∞—Ç—á —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–æ 27 —Å–æ–æ–±—â–µ–Ω–∏–π, –∞–ª—å–±–æ–º –æ—Å—Ç–∞–µ—Ç—Å—è —Ü–µ–ª—ã–º
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–ª—å–±–æ–º–æ–≤ –≤ –±–∞—Ç—á–µ
```
–ë–∞—Ç—á —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–ª—å–±–æ–º 1 (–ø–æ–ª–Ω—ã–π) + –∞–ª—å–±–æ–º 2 (—á–∞—Å—Ç–∏—á–Ω—ã–π)
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ê–ª—å–±–æ–º 2 –¥–æ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ—Ç –∞–ª—å–±–æ–º–æ–≤
```
–ë–∞—Ç—á —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–∞—Ç—á –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
```

## ‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

- **–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ï—Å–ª–∏ –∞–ª—å–±–æ–º–æ–≤ –Ω–µ—Ç, –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –î–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏  
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ú–∞–∫—Å–∏–º—É–º 10 —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

## üîÑ –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±–∞—Ç—á–∞–º–∏
- ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –±–µ–∑ breaking changes

## üéâ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ** –≤ –±–∞—Ç—á–µ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ.
–ê–ª—å–±–æ–º—ã —Ç–µ–ø–µ—Ä—å **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞–∑—Ä–µ–∑–∞—é—Ç—Å—è** –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏!

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–æ.** üöÄ